"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var r=e(require("http")),t=e(require("express")),s=e(require("cors")),n=e(require("smarkt")),i=e(require("yaml")),o=e(require("json5")),c=e(require("fs")),u=e(require("path")),a=e(require("front-matter")),l=e(require("toml")),p=e(require("hjson")),d=e(require("pluralize")),f=e(require("jsonata")),h=e(require("node-fetch")),y=e(require("chokidar"));function j(e){if(e.match(/\.([0-9a-z]+)(?:[?#]|$)/i))return e.match(/\.([0-9a-z]+)(?:[?#]|$)/i)[1]}function g(e,r){return function(e,r){if(!process.browser&&("hjson"===j(r)||"json"===j(r))){let t=c.readFileSync(u.join(e,r),"utf8");return p.parse(t)}}(e,r)||function(e,r){if(!process.browser&&"md"===j(r)){var t=c.readFileSync(u.join(e,r),"utf8");const{attributes:s,body:n}=a(t);return{...s,content:n}}}(e,r)||function(e,r){if(!process.browser&&"txt"===j(r)){return n.parse(c.readFileSync(u.join(e,r),"utf8"))}}(e,r)||function(e,r){if(!process.browser&&("yml"===j(r)||"yaml"===j(r))){return i.parse(c.readFileSync(u.join(e,r),"utf8"))}}(e,r)||function(e,r){if(!process.browser&&"json5"===j(r)){let t=c.readFileSync(u.join(e,r),"utf8");return o.parse(t)}}(e,r)||function(e,r){if(!process.browser&&"toml"===j(r)){let t=c.readFileSync(u.join(e,r),"utf8");return l.parse(t)}}(e,r)}const m={is:{image:e=>!!/.jpg|.jpeg|.png/.test(e)&&e,file:e=>!!/\.(?!png|jpg|jpeg).+$/.test(e)&&e.split(".")[0],folder:e=>!/\..+$/.test(e)&&e,singular:e=>d.isSingular(e),plural:e=>d.isPlural(e),index:e=>/^index..+$/.test(e),collection(e,r){let t=!1;return m.is.folder(r)&&(t=!0),t},item(e,r){let t=!1;return(m.is.file(r)||m.has.index(e,r))&&(t=!0),t},hidden:e=>/^_/.test(e)},has:{index(e,r){let t=!1;return m.is.folder(r)&&c.readdirSync(u.join(e+r)).map(e=>{m.is.index(e)&&(t=!0)}),t},children(e,r){let t=!1;return m.is.folder(r)&&c.readdirSync(u.join(e+r)).map(()=>{t=!0}),t}}};function v(e){let r=e;return c.readdirSync(e).map((t,s)=>function e(r,t,s,n,i){if(m.is.hidden(t))return;let o={_index:s,_name:t.split(".")[0]},a=t.split(".")[0];"home"===t&&(a="");let l=r.replace(i.replace(u.sep,""),"");if(o.url=u.join(l+a),o._source=u.join(r+a),m.is.folder(t)&&m.has.index(r,t),m.is.item(r,t)&&(o._collection=n,o._type=n||t.split(".")[0]),m.is.folder(t)){let s=u.join(r+t+"/"),n=t;c.readdirSync(s).map((r,t)=>{e(s,r,t,n,i)})}if(m.is.file(t)&&Object.assign(o,g(r,t)),m.is.folder(t)){let s=u.join(r+t+"/"),n=t;var p=[],d=[];c.readdirSync(u.join(r+t)).map((r,t)=>{if(m.is.singular(n)){if(o._type=n,m.is.image(r)){d.push({url:u.join("images",o.url,r)});var a=u.join(process.cwd(),s,r),l=u.join(process.cwd(),"images",o.url,r);console.log(a,l),c.existsSync(u.join(process.cwd(),"images"))||c.mkdirSync(u.join(process.cwd(),"images",o.url),{recursive:!0}),c.copyFile(a,l,e=>{if(e)throw e;console.log("source.txt was copied to destination.txt")})}if(m.is.index(r))Object.assign(o,g(s,r));else if(Object.assign(o,{[r.split(".")[0]]:g(s,r)}),m.has.index(s,r)){let e=r;c.readdirSync(s+r).map(r=>{m.is.index(r)&&Object.assign(o,{[e]:g(s+e,r)})})}}else m.is.index(r)?Object.assign(o,g(s,r)):p.push(e(s,r,t,n,i))}),p.length>0&&(o[n]=p),d.length>0&&(o.images=d)}return o}(e,t,s,null,r))}async function S(e,{resource1:r,resource2:t,query:s}){var n,i=f(`**[_type="${r}"]`);if(r&&!t){if(s){let e=[];for(let[r,t]of Object.entries(s)){let s=`[${r}=${t}]`;e.push(s)}i=f(`**[_type="${r}"]${e.toString()}`)}return i.evaluate(e)}if(r&&t){if(s){let e=[];for(let[r,t]of Object.entries(s)){let s=`[${r}=${t}]`;e.push(s)}i=f(`**[_type="${r}"][_name="${t}"]${e.toString()}`)}return i.evaluate(e)}if((!r||!t)&&s){if(n=s,0===Object.keys(n).length&&n.constructor===Object)return e;let r=[];for(let[e,t]of Object.entries(s)){let s=`[${e}=${t}]`;r.push(s)}return(i=f("**"+r.toString())).evaluate(e)}}function _(e,r,t){var s;for(s in e)s===r?e[r]=t(e[r]):"object"==typeof e[s]&&_(e[s],r,t)}class b{constructor(e,r,t){t&&(this._source=t),this._options={production:e},r&&Object.assign(this._options,{preview:r})}_process(e,r){return e=JSON.parse(e),r.preprocess?("content"===r.preprocess[0]&&(Array.isArray(e)?e.map(e=>{e.content&&_(e,"content",r.preprocess[1])}):_(e,"content",r.preprocess[1])),"item"===r.preprocess[0]&&(Array.isArray(e)?e.map(e=>r.preprocess[1](e)):e=r.preprocess[1](e)),"collection"===r.preprocess[0]&&Array.isArray(e)&&(e=r.preprocess[1](e)),e):e}get(e){var r=this._options;return(process.browser?window.fetch:h)(`${"development"===process.env.NODE_ENV?r.preview&&"undefined"!==this._source?r.preview:r.production:r.production?r.production:r.preview}${e}`).then(e=>e.text()).then(e=>{try{return this._process(e,r)}catch(r){return e}})}preprocess(e,r){Object.assign(this._options,{preprocess:[e,r]})}}module.exports=function(e){return new class{constructor(e){"undefined"!==e&&(this._source=e)}server(e,n){if(!this._source)return console.log("[Stancy] No source provided");e=e||4e3,n=n||"/",this._local=`http://localhost:${e}${n}`;var i,o,c=this._source;function u(){(i=r.createServer(function(e){var r=t();return o=v(c),r.use(s({origin:"*",methods:"GET,HEAD,PUT,PATCH,POST,DELETE",preflightContinue:!1,optionsSuccessStatus:204})),r.set("json spaces",4),r.get(e,(e,r)=>{S(o,{resource1:null,resource2:null,query:e.query}).then(t=>{t?r.json(t):r.send("[Stancy] No value that matches query \n "+e.url)})}),r.get(e+":resource1",(e,r)=>{S(o,{resource1:e.params.resource1,resource2:null,query:e.query}).then(t=>{t?r.json(t):r.send("[Stancy] No value that matches query \n "+e.url)})}),r.get(e+":resource1/:resource2",(e,r)=>{S(o,{resource1:e.params.resource1,resource2:e.params.resource2,query:e.query}).then(t=>{t?r.json(t):r.send("[Stancy] No value that matches query \n "+e.url)})}),r}(n))).listen(e,()=>{console.log(`[Stancy] Content server available at http://localhost:${e}${n}`)})}u(),y.watch(c,{ignored:/(^|[/\\])\../,persistent:!0}).on("change",()=>{i.close(),console.log("API server restarting"),u()})}client(e){return this._local||process.browser||this.server(),new b(e,this._local,this._source)}database(){return v(this._source)}}(e)};
